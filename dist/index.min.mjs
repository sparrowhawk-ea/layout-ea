class t{static layout(t,e){const i=document.head.appendChild(document.createElement("STYLE"));if(!i.sheet)throw new Error("count not create CSS style sheet");return i.appendChild(document.createTextNode("")),new h(t,e).layout(i.sheet),i}}t.CLASS_PREFIX="layout-ea--",t.CONTAINER_PREFIX="layout-ea-";const e={containerClassSuffix:"grid",layout:(t,e,i,s)=>new a(t,i).layout(e,s)};class i{constructor(t){this.callback=t,this.mediaName="",this.cssRules=[]}child({e:t,cssSelector:e},i,s){this.callback&&(i=this.callback.eaChild(t,this.mediaName,e,i,s)),this.cssRules.push(e+i)}parent({e:t,cssSelector:e},i,s){this.callback&&(i=this.callback.eaParent(t,this.mediaName,e,i,s)),this.cssRules.push(e+i)}}class s{constructor(t,e,i){this.e=t,this.children={},this.childMatches={},this.path=(null==i?void 0:i.path)&&!e.startsWith("#")?i.path+" "+e:e,this.cssSelector=this.selector(t)}die(t,e){throw void 0!==e&&(t=t+": '"+e+"'"),new Error(this.path+" "+t)}getChildRefs(t,e,i){const s=Object.values(this.children),h={};let l=0;const a=t.flatMap((({selector:t,index:a})=>{if("_"===t)return new r(t,-1);if(t){e.selectorIncrement[t]?a+=e.iteration*e.selectorIncrement[t]:h[t]=(h[t]||0)+1;let i=this.childMatches[t];if(i||(this.childMatches[t]=i=s.filter((e=>e.e.matches(t)))),a<0)return i.map(((e,i)=>new r(t,i,!0,e)));if(a<i.length)return new r(t,a,!1,i[a])}else{e.indexIncrement?a+=e.iteration*e.indexIncrement:l++;const t=this.children[a];if(t)return new r("",a,!1,t)}return e.consumeAll||this.die(i+"index "+String(a)+" exceeds matches",t),[]})).filter(Boolean);0===e.indexIncrement&&(e.indexIncrement=l);for(const t in e.selectorIncrement)0===e.selectorIncrement[t]&&(e.selectorIncrement[t]=h[t]||0);return a}parseChildRefs(t,e,i){let s,r=t.split(",").map((t=>t.trim()));if(r[0].startsWith("[")){const e=t.indexOf("]");e<=0&&this.die(i+"missing ] in multi-child selector",t),r=t.substring(e).split(",").map((t=>t.trim())),s=t.substring(1,e).split(",").flatMap((t=>this.parseChildRef(t,i)))}else s=this.parseChildRef(r[0],i);return r.shift(),e.push(...r),s.filter(Boolean)}parseChildRef(t,e){if(t||this.die(e+"internal error empty selector for parseChildRef"),"_"===t)return[{selector:t,index:0}];let i="";if(!/^\d/.test(t)){const s=t.split("/").map((t=>t.trim()));if(s.length>2&&this.die(e+"invalid selector",t),i=s[0],1===s.length)return[{selector:i,index:0}];t=s[1]}const s=t.split("-").map((t=>t.trim()));s.length>2&&this.die(e+"invalid range",t);let r=this.parseIntOrWild(s[0],0,-1,{},e+"range from");const h=1===s.length?r:this.parseInt(s[1],r,"errLoc + range to"),l=[];for(;r<=h;)l.push({selector:i,index:r++});return l}parseInt(t,e,i){const s=Number.parseInt(t);return(Number.isNaN(s)||s<e)&&this.die(i,t),Math.floor(s)}parseIntOrWild(t,e,i,s,r){return t&&(t=s[t]||t),(null==t?void 0:t.startsWith("*"))?i:t?this.parseInt(t,e,r):e}setContainerClass(e){const i=t.CONTAINER_PREFIX+e;this.e.classList.contains(i)||this.e.classList.add(i)}selector(e){if(e.id)return"#"+e.id;for(const i in e.classList)if(i.startsWith(t.CLASS_PREFIX))return"."+i;const i=t.CLASS_PREFIX+String(s.classCounter++);return e.classList.add(i),"."+i}}s.classCounter=0;class r{constructor(t,e,i=!1,s){this.ref=t,this.isWildcard=i,this.child=s,this.duplicateReference=!1,this.isExplicit=(null==s?void 0:s.e.id)&&t.endsWith("#"+s.e.id)||!t,t?e>0&&(t+="/"+String(e)):t=String(e)}static markDuplicates(t,e,i){const s=new WeakMap;e.forEach((e=>{const r=e.childRef.child;if(!r)return;const h=s.get(r);h?e.childRef.isExplicit?(h.childRef.isExplicit&&e.childRef.die(t,i+"reference '"+e.childRef.ref+"' duplicates",h.childRef.ref),h.childRef.duplicateReference=!0,s.set(r,e)):h.childRef.isWildcard?(h.childRef.duplicateReference=!0,s.set(r,e)):e.childRef.duplicateReference=!0:s.set(r,e)}))}die(t,e,i){(this.child||new s(t.e,"BLANK",t)).die(e,i)}}class h{constructor(t,e){if(this.cssRulesForElementPerMedia=new WeakMap,this.layoutForMediaAndSelector={},this.cssRulesForMedia=[],this.fallbackMediaName="",e.layout&&e.mediaLayouts)throw new Error("config layout and mediaLayouts are mutually exclusive");this.callback=new i(e.callback);const r=e.dataPrefix||"ea";this.dataPropIgnore=r+"X",this.dataPropIndex=r+"I",this.debugPrefix=e.debug?"LayoutEa:":"",this.ignore=e.ignore||[],this.layoutRules={};const h=e.layout||{};for(const t in h)t.split(",").forEach((e=>this.layoutRules[e]=h[t]));this.layoutSelectors=Object.keys(this.layoutRules).sort(),this.mediaLayouts=e.mediaLayouts,this.root=new s(t,this.makeName(t)),this.sizes=e.sizes||{},this.strategy=e.strategy,Object.keys(this.sizes).forEach((t=>{if(t.startsWith("*")||/^\d/.test(t))throw new Error("invalid key in config sizes: "+t)}))}layout(t){if(this.layoutSelectors.length>0)this.layoutDepthFirst(this.root),this.cssRulesForMedia.forEach((e=>t.insertRule(e)));else if(this.mediaLayouts){const e=[];this.mediaLayouts.forEach((({fallback:i,layout:s,mediaQuery:r,name:h})=>{r||this.root.die("missing media query"),i&&!e.includes(i)&&this.root.die("unknown fallback media name",i),e.push(h=h||r),this.layoutRules={};for(const t in s)t.split(",").forEach((e=>this.layoutRules[e]=s[t]));this.layoutSelectors=Object.keys(this.layoutRules).sort(),0===this.layoutSelectors.length&&this.root.die("missing layout provided for media "+h),this.callback.mediaName=h,this.cssRulesForMedia=[],this.fallbackMediaName=i||e[0],this.layoutDepthFirst(this.root),t.insertRule("@media "+r+"{"+this.cssRulesForMedia.join(" ")+"}")}))}}layoutDepthFirst(t){const e=this.layoutSelectors.find((e=>t.e.matches(e)))||"";let i=e?this.layoutRules[e]:void 0;const r=[];for(;null==i?void 0:i.startsWith("@");){r.includes(i)&&t.die("circular reference for layout",i);const e=this.layoutRules[i.substring(1)]||this.layoutForMediaAndSelector[i.substring(1)];e||t.die("no valid layout found at reference",i),i=e}for(let e=0,r=0;r<t.e.children.length;r++){const h=t.e.children[r];if(void 0!==h.dataset[this.dataPropIgnore]||this.ignore.find((t=>h.matches(t)))){this.debugPrefix&&console.log(this.debugPrefix,this.makeName(h),"ignored as instructed");continue}const l=new s(h,this.makeName(h),t);if(this.layoutDepthFirst(l),i){const i=h.dataset[this.dataPropIndex];void 0!==i&&(e=l.parseInt(i,e,"index "+i)),t.children[e++]=l}}let h=this.cssRulesForElementPerMedia.get(t.e),l=h&&!i?h[this.fallbackMediaName]:void 0;i&&(this.layoutForMediaAndSelector[this.callback.mediaName+":"+e]=i,this.callback.cssRules=[],this.strategy.layout(t,i,this.sizes,this.callback),void 0===h&&this.cssRulesForElementPerMedia.set(t.e,h={}),l=h[this.callback.mediaName]=this.callback.cssRules,t.setContainerClass(this.strategy.containerClassSuffix)),l&&this.cssRulesForMedia.push(...l)}makeName(t){if(t.id)return"#"+t.id;const e=t.tagName;if(!t.parentElement)throw new Error("orphan element "+e);const i=t.parentElement.children;let s=0;for(let r=0;r<i.length;r++){const h=i[r];if(t===h)return s?e+"/"+String(s):e;e===h.tagName&&void 0===h.dataset[this.dataPropIgnore]&&s++}throw new Error("could not match tag "+e)}}class l{constructor(t,e,i,s){this.consumeAll=e,this.selectorIncrement={},this.indexIncrement=0,this.iteration=0,i.forEach((e=>{const i=e.split("/").map((t=>t.trim()));i.length>2&&t.die(s+"invalid repeat spec",e),1===i.length?this.indexIncrement=t.parseInt(i[0],1,s+"invalid repeat index increment"):this.selectorIncrement[i[0]]=t.parseInt(i[1],1,s+"invalid repeat index increment for "+i[0])}))}}class a{constructor(t,e){this.parent=t,this.sizes=e,this.cellsAboveRow=[0],this.gridItems=[]}layout(t,e){const i=this.placeRows(this.parseLayout(t)),s=this.cellsAboveRow[this.cellsAboveRow.length-1];this.gridItems.forEach((t=>{const i=t.childRef.child;if(!i)return;const r=this.cellsAboveRow[t.row],h=(t.height?this.cellsAboveRow[t.row+t.height]:s)-r;e.child(i,"{grid-row:"+String(r+1)+"/span "+String(h)+";grid-column:"+String(t.col+1)+"/span "+String(t.width)+"}")})),e.parent(this.parent,"{display:grid;align-content:stretch;justify-content:stretch;grid-auto-columns:"+String(100/i)+"%;grid-auto-rows:"+String(100/s)+"%}")}errLoc(t,e=-1){return"(row:"+String(t)+(e<0?") ":" col:"+String(e)+") ")}parseLayout(t){const e=t.split(";").flatMap(((e,i)=>{const s=this.errLoc(i),r=e.trim().split(/\s+/).filter(Boolean);let h=1,a=1,o=[];for(;r.length>0&&(r[0].startsWith("+")||r[0].startsWith("*"));){const t=r.shift()||"",e=t.substring(1);t.startsWith("+")?h=this.parent.parseIntOrWild(e,1,1,this.sizes,s+"row height"):(a=e.startsWith("!")?0:this.parent.parseInt(e,1,s+"row repeat"),o=e.split(",").map((t=>t.trim())),o.shift())}const c=new l(this.parent,0===a,o,s),d=r.map(((e,s)=>{const r=this.errLoc(i,s),h=[],l=this.parent.parseChildRefs(e,h,r);return 0===l.length&&this.parent.die(r+"missing child reference",t),{childRefTemplates:l,forceWidth:h.length>0&&h[0].endsWith("!"),height:h.length>1?this.parent.parseIntOrWild(h[1],1,0,this.sizes,r+"item height"):1,toGridBottom:h.length>1&&h[1].endsWith("!"),width:h.length>0?this.parent.parseIntOrWild(h[0],1,0,this.sizes,r+"item width"):1}})),u=[];for(let t=this.cellsAboveRow[this.cellsAboveRow.length-1];c.consumeAll||c.iteration<a;c.iteration++){const e=d.flatMap(((t,e)=>this.parent.getChildRefs(t.childRefTemplates,c,this.errLoc(i,e)).map((e=>new n(e,this.cellsAboveRow.length-1,t)))));if(c.consumeAll&&c.iteration>0&&0===e.length)break;u.push(e),this.cellsAboveRow.push(t+=h)}return u}));return r.markDuplicates(this.parent,e.flat(),""),e.map((t=>t.filter((t=>!t.childRef.duplicateReference))))}placeItems(t,e,i,s){let r=0,h=0,l=h<i.length?i[h].col:s;e.forEach((e=>{const a=0===e.width;if(a&&(e.width=1),i.length>0&&h<i.length&&(a||r+e.width>l))for(;r+e.width>l&&l<s;){let a=h,n=r+e.width-l;for(;e.forceWidth&&n>0&&h<i.length&&!i[h].hasHardHeight;)n-=i[h++].width;if(n<=0)do{i[a].height=t-i[a].row}while(++a<h);else h<i.length&&(!e.forceWidth||i[h].hasHardHeight)&&h++,r=i[h-1].col+i[h-1].width;l=h<i.length?i[h].col:s}if(r+e.width>l&&e.childRef.die(this.parent,this.errLoc(t,r)+"width "+String(e.width)+" exceeds wall "+String(l)),a){for(;h<i.length&&!i[h].hasHardHeight;h++)i[h].height=t-i[h].row;l=i.length>0&&h<i.length?i[h].col:s,e.width=l-r}e.col=r,r+=e.width,1!==e.height&&(i.splice(h,0,e),h++),e.childRef.child&&this.gridItems.push(e)}))}placeRows(t){let e=0;t.forEach((t=>e=Math.max(e,t.reduce(((t,e)=>t+e.width),0))));let i=[];t.forEach(((t,s)=>{this.placeItems(s,t,i,e),i=i.filter((t=>0===t.height||t.row+t.height-1>s))}));const s=this.cellsAboveRow.length-1;return i.forEach((t=>{t.height>0&&t.childRef.die(this.parent,this.errLoc(t.row,t.col)+"height "+String(t.height)+" exceeds specification rows "+String(s)),t.height=s-t.row})),e}}class n{constructor(t,e,i){this.childRef=t,this.row=e,this.col=0,this.forceWidth=i.forceWidth,this.hasHardHeight=i.toGridBottom||i.height>0,this.height=i.height,this.width=i.width}}export{t as LayoutEa,e as LayoutEaGrid};